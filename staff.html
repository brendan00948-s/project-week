<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Panel – Macau Traffic Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        *{margin: 0;padding: 0;box-sizing: border-box;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        body{background: linear-gradient(rgba(0, 0, 0, .8), rgba(0, 0, 0, .8)), url(https://img1.wsimg.com/isteam/getty/2154404610) no-repeat center center fixed;background-size: cover;color: #fff;min-height: 100vh;padding: 20px;overflow-x: hidden}
        .container{max-width: 1400px;margin: 0 auto}
        header{text-align: center;padding: 20px 0;margin-bottom: 20px;background: rgba(0, 0, 0, .6);border-radius: 15px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18)}
        .logo-container{display: flex;align-items: center;justify-content: center;gap: 15px;margin-bottom: 10px}
        .logo{width: 80px;height: 80px;background: linear-gradient(45deg, #ffd700, #ff8c00);border-radius: 50%;display: flex;align-items: center;justify-content: center;box-shadow: 0 0 20px rgba(255, 215, 0, .5)}
        .logo i{font-size: 40px;color: #8b0000}
        h1{font-size: 2.8rem;text-shadow: 0 2px 4px rgba(0, 0, 0, .5);margin-bottom: 5px}
        .subtitle{font-size: 1.2rem;opacity: .9;max-width: 600px;margin: 0 auto 20px}
        .auth-section{background: rgba(255, 255, 255, .1);border-radius: 15px;padding: 25px;margin: 20px 0;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18);text-align: center}
        .auth-section h2{color: #ffd700;margin-bottom: 20px}
        .form-group{margin-bottom: 20px;text-align: left}
        .form-group label{display: block;margin-bottom: 8px;font-weight: bold}
        .form-group input, .form-group select, .form-group textarea{width: 100%;padding: 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, .3);background: rgba(0, 0, 0, .3);color: #fff;font-size: 1rem}
        .btn{padding: 12px 25px;border-radius: 30px;border: none;background: #ffd700;color: #000;font-weight: bold;cursor: pointer;transition: all .3s ease;display: inline-flex;align-items: center;gap: 8px}
        .btn: hover{transform: translateY(-3px);box-shadow: 0 5px 15px rgba(0, 0, 0, .3)}
        .btn i{font-size: 1.2rem}
        .btn-secondary{background: rgba(255, 255, 255, .1);color: #fff}
        .btn-danger{background: #ff4d4d;color: #fff}
        .btn-success{background: #4dff4d;color: #000}
        .btn-warning{background: #ff9900;color: #000}
        .btn-info{background: #17a2b8;color: #fff}
        .cameras-section, .news-section{display: none}
        .section-title{color: #ffd700;margin: 25px 0 15px;display: flex;align-items: center;gap: 10px}
        .camera-grid, .news-grid{display: grid;grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));gap: 20px;margin-top: 20px}
        .camera-card, .news-card{background: rgba(255, 255, 255, .1);border-radius: 15px;padding: 20px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18);transition: transform .3s ease;cursor: move}
        .camera-card: hover, .news-card: hover{transform: translateY(-5px);box-shadow: 0 12px 40px rgba(0, 0, 0, .4)}
        .camera-card.dragging, .news-card.dragging{opacity: .5;transform: scale(.98)}
        .camera-title, .news-title{font-size: 1.2rem;margin-bottom: 15px;color: #ffd700;display: flex;align-items: center;gap: 10px}
        .camera-iframe{width: 100%;height: 180px;border-radius: 8px;border: none;margin: 10px 0;background: rgba(0, 0, 0, .3)}
        .camera-details, .news-details{margin: 15px 0}
        .camera-details p, .news-details p{margin: 8px 0;display: flex;gap: 10px}
        .camera-details strong, .news-details strong{min-width: 100px;display: inline-block}
        .camera-actions, .news-actions{display: flex;gap: 10px;margin-top: 15px;flex-wrap: wrap}
        .camera-actions .btn, .news-actions .btn{flex: 1;min-width: 120px;justify-content: center}
        .modal{display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, .8);z-index: 1000;align-items: center;justify-content: center}
        .modal-content{background: rgba(0, 0, 0, .9);border-radius: 15px;padding: 30px;width: 90%;max-width: 600px;box-shadow: 0 10px 30px rgba(0, 0, 0, .5);border: 1px solid rgba(255, 255, 255, .18);position: relative;max-height: 90vh;overflow-y: auto}
        .close-modal{position: absolute;top: 20px;right: 20px;font-size: 1.5rem;cursor: pointer;color: #ffd700}
        .modal h2{color: #ffd700;margin-bottom: 20px;text-align: center}
        .form-row{display: flex;gap: 15px;margin-bottom: 20px}
        .form-row .form-group{flex: 1}
        .status-indicator{display: inline-block;width: 12px;height: 12px;border-radius: 50%;margin-right: 8px}
        .status-connected{background-color: #4dff4d;box-shadow: 0 0 8px #4dff4d}
        .status-disconnected{background-color: #ff4d4d}
        .notification{position: fixed;top: 20px;right: 20px;padding: 15px 25px;border-radius: 8px;background: rgba(0, 0, 0, .8);border-left: 4px solid #4dff4d;box-shadow: 0 5px 15px rgba(0, 0, 0, .3);z-index: 2000;display: none;animation: slideIn .3s ease}
        .notification.error{border-left-color: #ff4d4d}
        @keyframes slideIn{from{transform: translateX(100%);opacity: 0}to{transform: translateX(0);opacity: 1}}
        footer{text-align: center;padding: 20px;margin-top: 30px;font-size: .9rem;opacity: .8;background: rgba(0, 0, 0, .6);border-radius: 15px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18)}
        @media(max-width: 768px){.form-row{flex-direction: column}.camera-grid, .news-grid{grid-template-columns: 1fr}h1{font-size: 2.2rem}}
        .stats-container{display: flex;gap: 20px;margin: 20px 0;flex-wrap: wrap}
        .stat-card{background: rgba(255, 255, 255, .1);border-radius: 10px;padding: 15px;text-align: center;flex: 1;min-width: 120px}
        .stat-value{font-size: 1.8rem;font-weight: bold;color: #ffd700;margin: 10px 0}
        .stat-label{font-size: .9rem;opacity: .8}
        .position-container{display: flex;gap: 10px;align-items: center}
        .position-input{flex: 1}
        .search-container{margin: 20px 0;display: flex;gap: 10px}
        .search-container input{flex: 1}
        .position-warning{color: #ff9900;font-size: .9rem;margin-top: 5px}
        .suggestion-list{position: absolute;background: rgba(0, 0, 0, .9);border: 1px solid rgba(255, 255, 255, .3);border-radius: 8px;max-height: 200px;overflow-y: auto;width: 100%;z-index: 100;display: none}
        .suggestion-item{padding: 10px;cursor: pointer}
        .suggestion-item: hover{background: rgba(255, 215, 0, .2)}
        .drag-over{border: 2px dashed #ffd700;background: rgba(255, 215, 0, .1)}
        .drag-handle{cursor: move;padding: 5px;margin-right: 10px;color: #ffd700}
        .tabs{display: flex;gap: 10px;margin: 20px 0;flex-wrap: wrap}
        .tab{padding: 12px 25px;border-radius: 30px;background: rgba(255, 255, 255, .1);color: #fff;cursor: pointer;transition: all .3s ease}
        .tab.active{background: #ffd700;color: #000}
        .news-content{white-space: pre-wrap;margin: 10px 0}
        .news-meta{display: flex;gap: 15px;margin-top: 10px;font-size: 0.9rem;opacity: 0.8}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo"><i class="fas fa-car"></i></div>
                <div><h1>Staff Panel</h1><p class="subtitle">Manage Live Camera Feeds and News for Macau Traffic Monitor</p></div>
            </div>
        </header>

        <div class="auth-section" id="authSection">
            <h2><i class="fas fa-lock"></i> Staff Login</h2>
            <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="Enter your staff email"></div>
            <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="Enter your password"></div>
            <button class="btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <p style="margin-top: 15px;color: #ffd700"><i class="fas fa-info-circle"></i> Get away and go lost if you're not staff</p>
        </div>

        <div class="cameras-section" id="camerasSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-video"></i> Live Camera Management</h2>
                <div><span class="status-indicator" id="statusIndicator"></span><span id="statusText">Connected to Firebase</span></div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="cameras">Cameras</div>
                <div class="tab" data-tab="news">News</div>
            </div>
            
            <div class="search-container"><input type="text" id="searchCamera" placeholder="Search camera by ID..."><button class="btn" id="searchBtn"><i class="fas fa-search"></i> Search</button></div>
            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn" id="addCameraBtn"><i class="fas fa-plus"></i> Add New Camera</button>
                <button class="btn btn-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="stats-container"><div class="stat-card"><div class="stat-label">Total Cameras</div><div class="stat-value" id="totalCameras">0</div></div></div>
            <div class="camera-grid" id="cameraGrid"></div>
        </div>

        <div class="news-section" id="newsSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-newspaper"></i> News Management</h2>
                <div><span class="status-indicator" id="newsStatusIndicator"></span><span id="newsStatusText">Connected to Firebase</span></div>
            </div>
            
            <div class="tabs">
                <div class="tab" data-tab="cameras">Cameras</div>
                <div class="tab active" data-tab="news">News</div>
            </div>
            
            <div class="search-container"><input type="text" id="searchNews" placeholder="Search news by ID..."><button class="btn" id="searchNewsBtn"><i class="fas fa-search"></i> Search</button></div>
            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn" id="addNewsBtn"><i class="fas fa-plus"></i> Add New News</button>
                <button class="btn btn-secondary" id="refreshNewsBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutNewsBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="stats-container"><div class="stat-card"><div class="stat-label">Total News Items</div><div class="stat-value" id="totalNews">0</div></div></div>
            <div class="news-grid" id="newsGrid"></div>
        </div>

        <div class="modal" id="cameraModal">
            <div class="modal-content">
                <span class="close-modal" id="closeModal">×</span>
                <h2 id="modalTitle">Add New Camera</h2>
                <div class="form-group"><label for="cameraId">Camera ID</label><div style="position: relative"><input type="text" id="cameraId" placeholder="Unique identifier (e.g.,  camera-001)"><div class="suggestion-list" id="suggestionList"></div></div></div>
                <div class="form-row"><div class="form-group"><label for="englishTitle">English Title</label><input type="text" id="englishTitle" placeholder="Camera title in English"></div><div class="form-group"><label for="chineseTitle">Chinese Title</label><input type="text" id="chineseTitle" placeholder="Camera title in Chinese"></div></div>
                <div class="form-row"><div class="form-group"><label for="portugueseTitle">Portuguese Title</label><input type="text" id="portugueseTitle" placeholder="Camera title in Portuguese"></div><div class="form-group"><label for="japaneseTitle">Japanese Title</label><input type="text" id="japaneseTitle" placeholder="Camera title in Japanese"></div></div>
                <div class="form-group"><label for="embedUrl">Embed URL</label><input type="text" id="embedUrl" placeholder="Live stream URL (e.g.,  https: //...)"></div>
                <div class="form-group"><label for="location">Location</label><select id="location" class="form-control"><option value="macau-city">Macau City</option><option value="taipa">Taipa</option><option value="bridges">Cross-Sea Bridges</option><option value="border">Border Crossings</option></select></div>
                <div class="form-group"><label for="position">Position</label><div class="position-container"><input type="number" id="position" class="position-input" min="1" placeholder="Position number"><span id="positionExample" style="opacity: .7">e.g. Macau City - 1</span></div><div id="positionWarning" class="position-warning" style="display: none"></div></div>
                <div style="display: flex;gap: 15px;margin-top: 25px"><button class="btn" id="saveCameraBtn"><i class="fas fa-save"></i> Save Camera</button><button class="btn btn-secondary" id="cancelBtn"><i class="fas fa-times"></i> Cancel</button></div>
            </div>
        </div>

        <div class="modal" id="newsModal">
            <div class="modal-content">
                <span class="close-modal" id="closeNewsModal">×</span>
                <h2 id="newsModalTitle">Add New News</h2>
                
                <div class="form-group">
                    <label for="newsId">News ID</label>
                    <input type="text" id="newsId" placeholder="Unique identifier (e.g.,  news-001)">
                </div>
                
                <div class="form-group">
                    <label for="newsTitle">Title</label>
                    <input type="text" id="newsTitle" placeholder="News title">
                </div>
                
                <div class="form-group">
                    <label for="newsContent">Content</label>
                    <textarea id="newsContent" rows="5" placeholder="News content..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newsCategory">Category</label>
                        <select id="newsCategory">
                            <option value="traffic">Traffic</option>
                            <option value="incident">Incident</option>
                            <option value="construction">Construction</option>
                            <option value="weather">Weather</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newsPriority">Priority</label>
                        <select id="newsPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newsPosition">Position</label>
                    <input type="number" id="newsPosition" min="1" placeholder="Position number">
                    <div id="newsPositionExample" style="opacity: .7; margin-top: 5px">e.g. Position 1 will appear first</div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 25px">
                    <button class="btn" id="saveNewsBtn"><i class="fas fa-save"></i> Save News</button>
                    <button class="btn btn-secondary" id="cancelNewsBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"><p id="notificationMessage">Operation completed successfully!</p></div>
        <footer><p>Macau Traffic Monitor Staff Panel © 2026</p><p>Data Source:  Firebase Realtime Database</p></footer>
    </div>

    <script>
        const firebaseConfig={
            apiKey: "AIzaSyB1_sJvG1u47J3K0K0K0K0K0K0K0K0K0K0", 
            authDomain: "macau-traffic-501cb.firebaseapp.com", 
            databaseURL: "https://macau-traffic-501cb-default-rtdb.firebaseio.com", 
            projectId: "macau-traffic-501cb", 
            storageBucket: "macau-traffic-501cb.appspot.com", 
            messagingSenderId: "123456789012", 
            appId: "1: 123456789012: web: abcdef1234567890abcdef"
        };
        firebase.initializeApp(firebaseConfig);
        const database=firebase.database();

        // DOM Elements
        const authSection=document.getElementById('authSection');
        const camerasSection=document.getElementById('camerasSection');
        const newsSection=document.getElementById('newsSection');
        const cameraGrid=document.getElementById('cameraGrid');
        const newsGrid=document.getElementById('newsGrid');
        const cameraModal=document.getElementById('cameraModal');
        const newsModal=document.getElementById('newsModal');
        const notification=document.getElementById('notification');
        const statusIndicator=document.getElementById('statusIndicator');
        const statusText=document.getElementById('statusText');
        const newsStatusIndicator=document.getElementById('newsStatusIndicator');
        const newsStatusText=document.getElementById('newsStatusText');
        const totalCamerasEl=document.getElementById('totalCameras');
        const totalNewsEl=document.getElementById('totalNews');

        // Buttons
        const loginBtn=document.getElementById('loginBtn');
        const addCameraBtn=document.getElementById('addCameraBtn');
        const refreshBtn=document.getElementById('refreshBtn');
        const logoutBtn=document.getElementById('logoutBtn');
        const saveCameraBtn=document.getElementById('saveCameraBtn');
        const cancelBtn=document.getElementById('cancelBtn');
        const closeModal=document.getElementById('closeModal');
        const searchBtn=document.getElementById('searchBtn');
        
        const addNewsBtn=document.getElementById('addNewsBtn');
        const refreshNewsBtn=document.getElementById('refreshNewsBtn');
        const logoutNewsBtn=document.getElementById('logoutNewsBtn');
        const saveNewsBtn=document.getElementById('saveNewsBtn');
        const cancelNewsBtn=document.getElementById('cancelNewsBtn');
        const closeNewsModal=document.getElementById('closeNewsModal');
        const searchNewsBtn=document.getElementById('searchNewsBtn');

        // Camera Form Elements
        const emailInput=document.getElementById('email');
        const passwordInput=document.getElementById('password');
        const cameraIdInput=document.getElementById('cameraId');
        const englishTitleInput=document.getElementById('englishTitle');
        const chineseTitleInput=document.getElementById('chineseTitle');
        const portugueseTitleInput=document.getElementById('portugueseTitle');
        const japaneseTitleInput=document.getElementById('japaneseTitle');
        const embedUrlInput=document.getElementById('embedUrl');
        const locationSelect=document.getElementById('location');
        const positionInput=document.getElementById('position');
        const searchCameraInput=document.getElementById('searchCamera');
        const positionWarning=document.getElementById('positionWarning');
        const suggestionList=document.getElementById('suggestionList');

        // News Form Elements
        const newsIdInput=document.getElementById('newsId');
        const newsTitleInput=document.getElementById('newsTitle');
        const newsContentInput=document.getElementById('newsContent');
        const newsCategorySelect=document.getElementById('newsCategory');
        const newsPrioritySelect=document.getElementById('newsPriority');
        const newsPositionInput=document.getElementById('newsPosition');
        const searchNewsInput=document.getElementById('searchNews');

        // State variables
        let currentEditingCameraId=null;
        let currentEditingNewsId=null;
        let isAuthenticated=false;
        let allCameras={};
        let allNews={};
        let draggedItem=null;

        // Initialize the application
        function init(){
            updateConnectionStatus(true);
            loadCameras();
            loadNews();
            
            // Add event listeners for tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabType = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show/hide sections
                    if(tabType === 'cameras') {
                        camerasSection.style.display = 'block';
                        newsSection.style.display = 'none';
                    } else {
                        camerasSection.style.display = 'none';
                        newsSection.style.display = 'block';
                    }
                });
            });
            
            // Camera form event listeners
            locationSelect.addEventListener('change', updatePositionExample);
            positionInput.addEventListener('input', validatePosition);
            cameraIdInput.addEventListener('input', showSuggestions);
            document.addEventListener('click', e=>{if(!e.target.closest('#cameraId'))suggestionList.style.display='none'});
        }

        // Show suggestions for camera IDs
        function showSuggestions(){
            const input=cameraIdInput.value.toLowerCase();
            suggestionList.innerHTML='';
            if(input.length<2){suggestionList.style.display='none';return}
            const suggestions=Object.keys(allCameras).filter(id=>id.toLowerCase().includes(input)).slice(0, 5);
            if(suggestions.length>0){
                suggestions.forEach(id=>{
                    const item=document.createElement('div');item.className='suggestion-item';item.textContent=id;
                    item.addEventListener('click', ()=>{cameraIdInput.value=id;suggestionList.style.display='none';fillFormWithCameraData(id)});
                    suggestionList.appendChild(item);
                });suggestionList.style.display='block';
            }else{suggestionList.style.display='none'}
        }

        // Fill camera form with existing data
        function fillFormWithCameraData(cameraId){
            const camera=allCameras[cameraId];
            if(camera){
                englishTitleInput.value=camera.titles.en||'';
                chineseTitleInput.value=camera.titles.zh||'';
                portugueseTitleInput.value=camera.titles.pt||'';
                japaneseTitleInput.value=camera.titles.ja||'';
                embedUrlInput.value=camera.embedUrl||'';
                locationSelect.value=camera.location||'macau-city';
                positionInput.value=camera.position||'';
                updatePositionExample();validatePosition();
            }
        }

        // Update position example text
        function updatePositionExample(){
            const locationText=locationSelect.options[locationSelect.selectedIndex].text;
            document.getElementById('positionExample').textContent=`e.g. ${locationText} - 1`;
        }

        // Validate camera position
        function validatePosition(){
            const position=positionInput.value.trim();
            const location=locationSelect.value;
            if(!position){positionWarning.style.display='none';return}
            const positionNum=parseInt(position);
            let conflictCameraId=null;
            Object.keys(allCameras).forEach(cameraId=>{
                const camera=allCameras[cameraId];
                if(camera.location===location&&camera.position===positionNum&&cameraId!==currentEditingCameraId)conflictCameraId=cameraId;
            });
            if(conflictCameraId){
                positionWarning.textContent=`Position ${positionNum} is already occupied by camera ID:  ${conflictCameraId}. Saving will move that camera to the back.`;
                positionWarning.style.display='block';
            }else{positionWarning.style.display='none'}
        }

        // Update connection status indicator
        function updateConnectionStatus(connected){
            statusIndicator.className=connected?'status-indicator status-connected': 'status-indicator status-disconnected';
            statusText.textContent=connected?'Connected to Firebase': 'Disconnected from Firebase';
            newsStatusIndicator.className=connected?'status-indicator status-connected': 'status-indicator status-disconnected';
            newsStatusText.textContent=connected?'Connected to Firebase': 'Disconnected from Firebase';
        }

        // Show notification message
        function showNotification(message, isError=false){
            document.getElementById('notificationMessage').textContent=message;
            notification.className=isError?'notification error': 'notification';
            notification.style.display='block';
            setTimeout(()=>notification.style.display='none', 3000);
        }

        // Login function
        function login(){
            const email=emailInput.value.trim();
            const password=passwordInput.value.trim();
            if(!email||!password){showNotification('Please enter both email and password', true);return}
            if(email==='admin@macautraffic.com'&&password==='Admin123'){
                isAuthenticated=true;
                authSection.remove(); // ✅ login panel completely removed
                camerasSection.style.display='block';
                showNotification('Login successful!');
            }else{showNotification('Invalid credentials. Please try again.', true)}
        }

        // Logout function
        function logout(){
            isAuthenticated=false;
            camerasSection.style.display='none';
            newsSection.style.display='none';
            emailInput.value='';passwordInput.value='';
            showNotification('You have been logged out');
            location.reload(); // simple way back to login
        }

        // Search camera function
        function searchCamera(){
            const searchTerm=searchCameraInput.value.trim().toLowerCase();
            if(!searchTerm){showNotification('Please enter a camera ID to search', true);return}
            const foundCameraId=Object.keys(allCameras).find(id=>id.toLowerCase().includes(searchTerm));
            foundCameraId?editCamera(foundCameraId): showNotification('Camera not found', true);
        }

        // Search news function
        function searchNews(){
            const searchTerm=searchNewsInput.value.trim().toLowerCase();
            if(!searchTerm){showNotification('Please enter a news ID to search', true);return}
            const foundNewsId=Object.keys(allNews).find(id=>id.toLowerCase().includes(searchTerm));
            foundNewsId?editNews(foundNewsId): showNotification('News item not found', true);
        }

        // Load cameras from Firebase
        function loadCameras(){
            cameraGrid.innerHTML='<p style="text-align: center;width: 100%"><i class="fas fa-spinner fa-spin"></i> Loading cameras...</p>';
            database.ref('cameras').once('value').then(snapshot=>{
                const cameras=snapshot.val();
                if(cameras){allCameras=cameras;displayCameras(cameras);updateCameraStats()}
                else{cameraGrid.innerHTML='<p style="text-align: center;width: 100%">No cameras found</p>';allCameras={};updateCameraStats()}
            }).catch(err=>{console.error(err);cameraGrid.innerHTML='<p style="text-align: center;width: 100%;color: #ff4d4d">Error loading cameras.</p>';showNotification('Failed to load cameras', true)});
        }

        // Load news from Firebase
        function loadNews(){
            newsGrid.innerHTML='<p style="text-align: center;width: 100%"><i class="fas fa-spinner fa-spin"></i> Loading news...</p>';
            database.ref('news').once('value').then(snapshot=>{
                const news=snapshot.val();
                if(news){allNews=news;displayNews(news);updateNewsStats()}
                else{newsGrid.innerHTML='<p style="text-align: center;width: 100%">No news found</p>';allNews={};updateNewsStats()}
            }).catch(err=>{console.error(err);newsGrid.innerHTML='<p style="text-align: center;width: 100%;color: #ff4d4d">Error loading news.</p>';showNotification('Failed to load news', true)});
        }

        // Update camera statistics
        function updateCameraStats(){totalCamerasEl.textContent=Object.keys(allCameras).length}

        // Update news statistics
        function updateNewsStats(){totalNewsEl.textContent=Object.keys(allNews).length}

        // Display cameras
        function displayCameras(cameras){
            cameraGrid.innerHTML='';
            const camerasArray=Object.keys(cameras).map(id=>({id, ...cameras[id]}));
            camerasArray.sort((a, b)=>{if(a.position==null)return 1;if(b.position==null)return -1;return a.position-b.position});
            camerasArray.forEach(camera=>{
                const card=document.createElement('div');card.className='camera-card';card.setAttribute('data-id', camera.id);card.setAttribute('draggable', true);
                card.innerHTML=`
                    <div class="camera-title"><i class="fas fa-grip-vertical drag-handle"></i><i class="fas fa-video"></i> ${camera.titles.en}</div>
                    <div class="camera-details"><p><strong>ID: </strong> ${camera.id}</p><p><strong>Location: </strong> ${camera.location}</p><p><strong>Position: </strong> ${camera.position||'Not set'}</p><p><strong>URL: </strong> ${camera.embedUrl}</p></div>
                    <iframe class="camera-iframe" src="${camera.embedUrl}" allowfullscreen></iframe>
                    <div class="camera-actions"><button class="btn btn-secondary edit-btn" data-id="${camera.id}"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-danger delete-btn" data-id="${camera.id}"><i class="fas fa-trash"></i> Delete</button></div>`;
                cameraGrid.appendChild(card);
                card.addEventListener('dragstart', handleDragStart);card.addEventListener('dragover', handleDragOver);card.addEventListener('dragenter', handleDragEnter);card.addEventListener('dragleave', handleDragLeave);card.addEventListener('drop', handleDrop);card.addEventListener('dragend', handleDragEnd);
            });
            document.querySelectorAll('.edit-btn').forEach(btn=>btn.addEventListener('click', ()=>editCamera(btn.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn=>btn.addEventListener('click', ()=>deleteCamera(btn.dataset.id)));
        }

        // Display news items
        function displayNews(news){
            newsGrid.innerHTML='';
            const newsArray=Object.keys(news).map(id=>({id, ...news[id]}));
            newsArray.sort((a, b)=>{if(a.position==null)return 1;if(b.position==null)return -1;return a.position-b.position});
            newsArray.forEach(item=>{
                const card=document.createElement('div');card.className='news-card';card.setAttribute('data-id', item.id);card.setAttribute('draggable', true);
                
                // Format date for display
                const date = new Date(item.timestamp || Date.now());
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                card.innerHTML=`
                    <div class="news-title"><i class="fas fa-grip-vertical drag-handle"></i><i class="fas fa-newspaper"></i> ${item.title}</div>
                    <div class="news-content">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</div>
                    <div class="news-details">
                        <p><strong>ID: </strong> ${item.id}</p>
                        <p><strong>Category: </strong> ${item.category}</p>
                        <p><strong>Priority: </strong> ${item.priority}</p>
                        <p><strong>Position: </strong> ${item.position||'Not set'}</p>
                    </div>
                    <div class="news-meta">
                        <span><i class="far fa-calendar"></i> ${formattedDate}</span>
                    </div>
                    <div class="news-actions">
                        <button class="btn btn-secondary edit-news-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger delete-news-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>`;
                newsGrid.appendChild(card);
                card.addEventListener('dragstart', handleDragStart);card.addEventListener('dragover', handleDragOver);card.addEventListener('dragenter', handleDragEnter);card.addEventListener('dragleave', handleDragLeave);card.addEventListener('drop', handleDrop);card.addEventListener('dragend', handleDragEnd);
            });
            document.querySelectorAll('.edit-news-btn').forEach(btn=>btn.addEventListener('click', ()=>editNews(btn.dataset.id)));
            document.querySelectorAll('.delete-news-btn').forEach(btn=>btn.addEventListener('click', ()=>deleteNews(btn.dataset.id)));
        }

        // Drag and drop handlers
        function handleDragStart(){draggedItem=this;setTimeout(()=>this.classList.add('dragging'), 0)}
        function handleDragOver(e){e.preventDefault()}
        function handleDragEnter(e){e.preventDefault();this.classList.add('drag-over')}
        function handleDragLeave(){this.classList.remove('drag-over')}
        function handleDrop(e){e.preventDefault();this.classList.remove('drag-over');if(draggedItem!==this){const allItems=Array.from(this.parentElement.querySelectorAll('.camera-card, .news-card'));const draggedIndex=allItems.indexOf(draggedItem);const targetIndex=allItems.indexOf(this);if(draggedIndex<targetIndex)this.parentElement.insertBefore(draggedItem, this.nextSibling);else this.parentElement.insertBefore(draggedItem, this);updateCameraPositions();updateNewsPositions()}}
        function handleDragEnd(){this.classList.remove('dragging');draggedItem=null}

        // Update camera positions after drag and drop
        function updateCameraPositions(){
            const updates={};
            cameraGrid.querySelectorAll('.camera-card').forEach((card, index)=>updates[`cameras/${card.dataset.id}/position`]=index+1);
            database.ref().update(updates).then(()=>{showNotification('Camera positions updated!');loadCameras()}).catch(err=>{console.error(err);showNotification('Failed to update positions', true)})
        }

        // Update news positions after drag and drop
        function updateNewsPositions(){
            const updates={};
            newsGrid.querySelectorAll('.news-card').forEach((card, index)=>updates[`news/${card.dataset.id}/position`]=index+1);
            database.ref().update(updates).then(()=>{showNotification('News positions updated!');loadNews()}).catch(err=>{console.error(err);showNotification('Failed to update positions', true)})
        }

        // Open add camera modal
        function openAddCameraModal(){
            currentEditingCameraId=null;document.getElementById('modalTitle').textContent='Add New Camera';cameraIdInput.value='';cameraIdInput.disabled=false;englishTitleInput.value='';chineseTitleInput.value='';portugueseTitleInput.value='';japaneseTitleInput.value='';embedUrlInput.value='';locationSelect.value='macau-city';positionInput.value='';positionWarning.style.display='none';updatePositionExample();cameraModal.style.display='flex';
        }

        // Open add news modal
        function openAddNewsModal(){
            currentEditingNewsId=null;document.getElementById('newsModalTitle').textContent='Add New News';newsIdInput.value='';newsIdInput.disabled=false;newsTitleInput.value='';newsContentInput.value='';newsCategorySelect.value='traffic';newsPrioritySelect.value='medium';newsPositionInput.value='';newsModal.style.display='flex';
        }

        // Edit camera
        function editCamera(cameraId){
            currentEditingCameraId=cameraId;document.getElementById('modalTitle').textContent='Edit Camera';
            database.ref('cameras/'+cameraId).once('value').then(snapshot=>{
                const camera=snapshot.val();
                if(camera){
                    cameraIdInput.value=cameraId;cameraIdInput.disabled=true;englishTitleInput.value=camera.titles.en;chineseTitleInput.value=camera.titles.zh;portugueseTitleInput.value=camera.titles.pt;japaneseTitleInput.value=camera.titles.ja;embedUrlInput.value=camera.embedUrl;locationSelect.value=camera.location;positionInput.value=camera.position||'';positionWarning.style.display='none';updatePositionExample();validatePosition();cameraModal.style.display='flex';
                }else{showNotification('Camera not found', true)}
            }).catch(err=>{console.error(err);showNotification('Failed to load camera', true)})
        }

        // Edit news
        function editNews(newsId){
            currentEditingNewsId=newsId;document.getElementById('newsModalTitle').textContent='Edit News';
            database.ref('news/'+newsId).once('value').then(snapshot=>{
                const news=snapshot.val();
                if(news){
                    newsIdInput.value=newsId;newsIdInput.disabled=true;newsTitleInput.value=news.title;newsContentInput.value=news.content;newsCategorySelect.value=news.category;newsPrioritySelect.value=news.priority;newsPositionInput.value=news.position||'';newsModal.style.display='flex';
                }else{showNotification('News item not found', true)}
            }).catch(err=>{console.error(err);showNotification('Failed to load news item', true)})
        }

        // Save camera
        function saveCamera(){
            const cameraId=cameraIdInput.value.trim();
            const englishTitle=englishTitleInput.value.trim();
            const chineseTitle=chineseTitleInput.value.trim();
            const portugueseTitle=portugueseTitleInput.value.trim();
            const japaneseTitle=japaneseTitleInput.value.trim();
            const embedUrl=embedUrlInput.value.trim();
            const location=locationSelect.value;
            const position=positionInput.value.trim();
            if(!cameraId||!englishTitle||!embedUrl){showNotification('Please fill in all required fields', true);return}
            const cameraData={titles: {en: englishTitle, zh: chineseTitle, pt: portugueseTitle, ja: japaneseTitle}, embedUrl: embedUrl, location: location, position: position?parseInt(position): null};
            const positionNum=position?parseInt(position): null;let conflictCameraId=null;
            if(positionNum){Object.keys(allCameras).forEach(id=>{const camera=allCameras[id];if(camera.location===location&&camera.position===positionNum&&id!==cameraId)conflictCameraId=id})}
            if(conflictCameraId){
                const camerasInLocation=Object.values(allCameras).filter(cam=>cam.location===location&&cam.position!==null);
                const maxPosition=camerasInLocation.length>0?Math.max(...camerasInLocation.map(cam=>cam.position)): 0;
                const newPositionForConflicting=maxPosition+1;
                const updates={};updates[`cameras/${conflictCameraId}/position`]=newPositionForConflicting;updates[`cameras/${cameraId}`]=cameraData;
                database.ref().update(updates).then(()=>{showNotification(`Camera saved! Moved conflicting camera to position ${newPositionForConflicting}`);cameraModal.style.display='none';loadCameras()}).catch(err=>{console.error(err);showNotification('Failed to save camera', true)})
            }else{
                database.ref('cameras/'+cameraId).set(cameraData).then(()=>{showNotification(`Camera ${currentEditingCameraId?'updated': 'added'} successfully!`);cameraModal.style.display='none';loadCameras()}).catch(err=>{console.error(err);showNotification('Failed to save camera', true)})
            }
        }

        // Save news
        function saveNews(){
            const newsId=newsIdInput.value.trim();
            const title=newsTitleInput.value.trim();
            const content=newsContentInput.value.trim();
            const category=newsCategorySelect.value;
            const priority=newsPrioritySelect.value;
            const position=newsPositionInput.value.trim();
            
            if(!newsId||!title||!content){showNotification('Please fill in all required fields', true);return}
            
            const newsData={
                title: title, 
                content: content, 
                category: category, 
                priority: priority, 
                position: position ? parseInt(position) : null, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Check for position conflicts
            let conflictNewsId=null;
            const positionNum=position?parseInt(position): null;
            
            if(positionNum){
                Object.keys(allNews).forEach(id=>{
                    const news=allNews[id];
                    if(news.position===positionNum&&id!==newsId)conflictNewsId=id;
                });
            }
            
            if(conflictNewsId){
                // Move conflicting news to the end
                const newsInList=Object.values(allNews).filter(n=>n.position!==null);
                const maxPosition=newsInList.length>0?Math.max(...newsInList.map(n=>n.position)): 0;
                const newPositionForConflicting=maxPosition+1;
                
                const updates={};
                updates[`news/${conflictNewsId}/position`]=newPositionForConflicting;
                updates[`news/${newsId}`]=newsData;
                
                database.ref().update(updates)
                    .then(()=>{
                        showNotification(`News saved! Moved conflicting item to position ${newPositionForConflicting}`);
                        newsModal.style.display='none';
                        loadNews();
                    })
                    .catch(err=>{
                        console.error(err);
                        showNotification('Failed to save news', true);
                    });
            }else{
                database.ref('news/'+newsId).set(newsData)
                    .then(()=>{
                        showNotification(`News ${currentEditingNewsId?'updated': 'added'} successfully!`);
                        newsModal.style.display='none';
                        loadNews();
                    })
                    .catch(err=>{
                        console.error(err);
                        showNotification('Failed to save news', true);
                    });
            }
        }

        // Delete camera
        function deleteCamera(cameraId){
            if(confirm('Are you sure you want to delete this camera? This action cannot be undone.')){
                database.ref('cameras/'+cameraId).remove().then(()=>{showNotification('Camera deleted successfully!');loadCameras()}).catch(err=>{console.error(err);showNotification('Failed to delete camera', true)})
            }
        }

        // Delete news
        function deleteNews(newsId){
            if(confirm('Are you sure you want to delete this news item? This action cannot be undone.')){
                database.ref('news/'+newsId).remove().then(()=>{showNotification('News item deleted successfully!');loadNews()}).catch(err=>{console.error(err);showNotification('Failed to delete news item', true)})
            }
        }

        // Close modals
        function closeCameraModal(){cameraModal.style.display='none';cameraIdInput.disabled=false;suggestionList.style.display='none'}
        function closeNewsModalFunc(){newsModal.style.display='none';newsIdInput.disabled=false;}

        // Event Listeners
        loginBtn.addEventListener('click', login);
        addCameraBtn.addEventListener('click', openAddCameraModal);
        refreshBtn.addEventListener('click', loadCameras);
        logoutBtn.addEventListener('click', logout);
        saveCameraBtn.addEventListener('click', saveCamera);
        cancelBtn.addEventListener('click', closeCameraModal);
        closeModal.addEventListener('click', closeCameraModal);
        searchBtn.addEventListener('click', searchCamera);
        
        addNewsBtn.addEventListener('click', openAddNewsModal);
        refreshNewsBtn.addEventListener('click', loadNews);
        logoutNewsBtn.addEventListener('click', logout);
        saveNewsBtn.addEventListener('click', saveNews);
        cancelNewsBtn.addEventListener('click', closeNewsModalFunc);
        closeNewsModal.addEventListener('click', closeNewsModalFunc);
        searchNewsBtn.addEventListener('click', searchNews);
        
        window.addEventListener('click', e=>{
            if(e.target===cameraModal)closeCameraModal();
            if(e.target===newsModal)closeNewsModalFunc();
        });

        // Initialize the app
        init();
    </script>
</body>
</html>
